name: E2E Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  test-action:
    name: Test Action End-to-End
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Create a test git history
      - name: Setup test repository
        shell: bash
        run: |
          git config user.name "Test Bot"
          git config user.email "test@example.com"

          # Remove existing version tags to prevent conflicts with test scenario
          git tag -l 'v*' | xargs -r git tag -d 2>/dev/null || true

          # Create initial commit if needed
          if ! git rev-parse HEAD >/dev/null 2>&1; then
            echo "# Test Repo" > README.md
            git add README.md
            git commit -m "feat: initial commit"
          fi

          # Create a test tag to simulate previous release
          git tag -f v0.1.0 HEAD~1 2>/dev/null || git tag v0.1.0

          # Create a new commit to trigger a release
          echo "test change" >> README.md
          git add README.md
          git commit -m "feat: add test feature" || true

      # Test plan command
      - name: Test - Plan
        uses: ./
        with:
          version: latest
          command: plan
          github-token: ${{ secrets.GITHUB_TOKEN }}
          dry-run: true

      # Test bump command (standalone)
      - name: Test - Bump
        uses: ./
        with:
          command: bump
          github-token: ${{ secrets.GITHUB_TOKEN }}
          dry-run: true

      # Note: Full workflow with dry-run is not currently testable because
      # dry-run mode prevents state persistence between plan/notes/approve/publish.
      # The individual plan and bump commands above verify the binary works correctly.
      # Full workflow testing should be done in a real release scenario.

      - name: Verify binary installation
        run: |
          echo "✅ relicta binary installed and executed successfully!"
          echo "✅ Plan and bump commands work correctly"
